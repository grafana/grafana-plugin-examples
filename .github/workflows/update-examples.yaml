name: Update plugin examples from create-plugin

on:
  schedule:
    - cron: "0 0 * * 0" # Run weekly (every Sunday at midnight UTC)
  workflow_dispatch: # Enable manual trigger
  repository_dispatch: # Enable external trigger
  push:
    branches:
      - academo/scaffold-basic-examples

jobs:
  generate-new-examples:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        examples: ['panel-basic', 'datasource-basic', 'app-basic', 'datasource-with-backend', 'app-with-backend']
        include:
          - examples: panel-basic
            plugin-name: basic
            plugin-org: grafana
            plugin-type: panel
            has-backend: false
            artifact-name: panel-basic
          - examples: datasource-basic
            plugin-name: basic
            plugin-org: grafana
            plugin-type: datasource
            has-backend: false
            artifact-name: datasource-basic
          - examples: app-basic
            plugin-name: basic
            plugin-org: grafana
            plugin-type: app
            has-backend: false
            artifact-name: app-basic
          - examples: datasource-with-backend
            plugin-name: backend
            plugin-org: grafana
            plugin-type: datasource
            has-backend: true
            artifact-name: datasource-with-backend
          - examples: app-with-backend
            plugin-name: backend
            plugin-org: grafana
            plugin-type: app
            has-backend: true
            artifact-name: app-with-backend
    steps:
      - name: Setup nodejs 22
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Run create plugin
        id: generate
        shell: bash
        run: |
          CMD_ARGS="--plugin-name=${PLUGIN_NAME} --org-name=${PLUGIN_ORG} --plugin-type=${PLUGIN_TYPE}"
          # based on has-backend pass --backend or --no-backend
          if [ "${HAS_BACKEND}" = "true" ]; then
            CMD_ARGS="$CMD_ARGS --backend"
          else
            CMD_ARGS="$CMD_ARGS --no-backend"
          fi
          npx -y @grafana/create-plugin@latest $(echo $CMD_ARGS)
          DIR_NAME="$PLUGIN_ORG-$PLUGIN_NAME-$PLUGIN_TYPE"
          echo "plugin-dir=$DIR_NAME" >> $GITHUB_OUTPUT
          echo "Plugin Generated at $DIR_NAME"
        env:
          PLUGIN_NAME: ${{ matrix.plugin-name }}
          PLUGIN_ORG: ${{ matrix.plugin-org }}
          PLUGIN_TYPE: ${{ matrix.plugin-type }}
          HAS_BACKEND: ${{ matrix.has-backend }}

      - name: Setup Go environment
        if: matrix.has-backend == 'true'
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: './${{ steps.generate.outputs.plugin-dir }}/go.mod'

      - name: Build backend
        if: matrix.has-backend == 'true'
        uses: magefile/mage-action@6f50bbb8ea47d56e62dee92392788acbc8192d0b # v3.1.0
        with:
          version: latest
          args: build:linux
          workdir: ${{ steps.generate.outputs.plugin-dir }}

      - name: Build plugin frontend
        id: build
        shell: bash
        run: |
          npm install
          npm run build
        working-directory: ${{ steps.generate.outputs.plugin-dir }}

      - name: Clean up
        shell: bash
        run: |
          rm -rf node_modules
          rm -rf dist
        working-directory: ${{ steps.generate.outputs.plugin-dir }}



      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.artifact-name}}
          path: ./${{steps.generate.outputs.plugin-dir}}
          if-no-files-found: error
          overwrite: true
          include-hidden-files: true


  update-examples:
    runs-on: ubuntu-latest
    needs: generate-new-examples
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: ls examples
        shell: bash
        run: |
          ls examples


      - name: Download panel-basic
        uses: actions/download-artifact@v4
        with:
          name: panel-basic
          path: ./panel-basic

      - name: Download datasource-basic
        uses: actions/download-artifact@v4
        with:
          name: datasource-basic
          path: ./datasource-basic

      - name: Download app-basic
        uses: actions/download-artifact@v4
        with:
          name: app-basic
          path: ./app-basic

      - name: Download datasource-with-backend
        uses: actions/download-artifact@v4
        with:
          name: datasource-with-backend
          path: ./datasource-with-backend

      - name: Download app-with-backend
        uses: actions/download-artifact@v4
        with:
          name: app-with-backend
          path: ./app-with-backend

      - name: Remove existing examples
        shell: bash
        run: |
          pushd examples
          rm -rf panel-basic datasource-basic app-basic datasource-with-backend app-with-backend
          popd

      - name: Move new examples
        shell: bash
        run: |
          mv panel-basic examples/panel-basic
          mv datasource-basic examples/datasource-basic
          mv app-basic examples/app-basic
          mv datasource-with-backend examples/datasource-with-backend
          mv app-with-backend examples/app-with-backend

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          title: "Chore: Update plugin examples to latest version"
          commit-message: "Automated update to latest version"
          body: |
            This is an auto-generated PR
            
            It updates all the examples based on the latest version of create-plugin.
          branch: update-plugin-examples
          delete-branch: true
          # base: main

